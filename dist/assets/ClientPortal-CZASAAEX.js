import{r,j as e}from"./vendor-react-Ce27NbrU.js";import{s as p}from"./index-BFvmHygk.js";import{a as Q,m as x,a6 as X,x as D,V as F,a5 as J,q as Z,aj as H,at as S,T as ee,d as z,D as L,aK as O,j as te,aW as se}from"./vendor-ui-TjLGESBy.js";import"./vendor-supabase-CSCOup90.js";import"./vendor-utils-DKqDJWuS.js";const V="".replace(/\D/g,""),xe=()=>{const[n,q]=r.useState(null),[b,u]=r.useState("idle"),[I,g]=r.useState(""),[y,f]=r.useState("welcome"),[l,M]=r.useState(null),[m,N]=r.useState([]),[ae,le]=r.useState(null),[h,v]=r.useState("idle"),[k,R]=r.useState({current:0,total:0});r.useEffect(()=>{let s=new URLSearchParams(window.location.search).get("token");if(!s&&window.location.hash){const a=window.location.hash.includes("?")?window.location.hash.split("?")[1]:"";a&&(s=new URLSearchParams(a).get("token"))}q(s)},[]);const P=r.useCallback(async()=>{if(n){u("loading"),g("");try{const{data:t,error:s}=await p.functions.invoke("client-portal",{body:{action:"get_photos",token:n}});if(s)throw new Error(s.message);if(t!=null&&t.error)throw new Error(t.error);M(t.booking),N(t.images||[]),u("loaded")}catch(t){console.error("Portal fetch error:",t),g(t.message||"حدث خطأ في تحميل الصور"),u("error")}}},[n]),G=r.useCallback(()=>{f("gallery"),P()},[P]),U=r.useCallback(async(t,s)=>{if(!n)return;const a=s==="selected",i=new Date().toISOString(),{error:c,data:d}=await p.functions.invoke("client-portal",{body:{action:"update_selection",token:n,selections:[{imageId:t,status:s,liked:a}]}});if(c)throw new Error(c.message||"Failed to sync selection");if(d!=null&&d.error)throw new Error(d.error);try{await p.from("session_images").update({is_selected:a,status:s,liked:a,updated_at:i}).eq("id",t)}catch{}try{await p.from("photos").update({is_selected:a}).eq("id",t)}catch{}},[n]),E=r.useCallback(async t=>{let s="pending",a="pending";N(i=>i.map(c=>c.id!==t?c:(s=c.status,a=c.status==="selected"?"pending":"selected",{...c,status:a})));try{await U(t,a)}catch(i){N(c=>c.map(d=>d.id===t?{...d,status:s}:d)),g((i==null?void 0:i.message)||"فشل تحديث الاختيار")}},[U]),W=r.useCallback(t=>{E(t)},[E]),_=r.useCallback(()=>{f("review")},[]),B=r.useCallback(async()=>{if(n){u("submitting");try{const t=m.map(d=>({imageId:d.id,status:d.status,liked:d.status==="selected"})),{data:s,error:a}=await p.functions.invoke("client-portal",{body:{action:"update_selection",token:n,selections:t}});if(a)throw new Error(a.message);const{data:i,error:c}=await p.functions.invoke("client-portal",{body:{action:"confirm_selection",token:n}});if(c)throw new Error(c.message);u("submitted"),f("done")}catch(t){console.error("Submit error:",t),g(t.message||"حدث خطأ في إرسال الاختيار"),u("loaded")}}},[n,m]),T=r.useCallback(()=>{if(!V){g("رقم واتساب المصور غير مضبوط. أضف VITE_PHOTOGRAPHER_WHATSAPP.");return}if(j.length===0){g("لا توجد صور مختارة لإرسالها.");return}const t=j.map((a,i)=>`${i+1}) ${a.cloudUrl||a.thumbnailUrl||a.fileName}`).join(`
`),s=["تم إكمال اختيار الصور من العميل",l!=null&&l.clientName?`العميل: ${l.clientName}`:"",l!=null&&l.title?`الجلسة: ${l.title}`:"",n?`Token: ${n}`:"",`عدد الصور المختارة: ${j.length}`,"","روابط الصور المختارة:",t].filter(Boolean).join(`
`);window.open(`https://wa.me/${V}?text=${encodeURIComponent(s)}`,"_blank")},[l==null?void 0:l.clientName,l==null?void 0:l.title,j,n]),$=r.useCallback(async()=>{if(!(!n||h==="downloading")){v("downloading");try{const{data:t,error:s}=await p.functions.invoke("client-portal",{body:{action:"get_download_urls",token:n}});if(s)throw new Error(s.message);if(t!=null&&t.error)throw new Error(t.error);const a=t.downloads||[];R({current:0,total:a.length});for(let i=0;i<a.length;i++){const{fileName:c,url:d}=a[i];try{const Y=await(await fetch(d)).blob(),A=URL.createObjectURL(Y),w=document.createElement("a");w.href=A,w.download=c,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(A),R({current:i+1,total:a.length}),i<a.length-1&&await new Promise(K=>setTimeout(K,300))}catch{console.warn(`Failed to download: ${c}`)}}v("done"),setTimeout(()=>v("idle"),3e3)}catch(t){console.error("Download error:",t),v("idle")}}},[n,h]),o=r.useMemo(()=>m.filter(t=>t.status==="selected").length,[m]),C=m.length,j=r.useMemo(()=>m.filter(t=>t.status==="selected"),[m]);return e.jsx("div",{className:"min-h-screen bg-[#0f0f0f] text-white font-sans",dir:"rtl",children:e.jsxs(Q,{mode:"wait",children:[y==="welcome"&&e.jsxs(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,y:-20},className:"min-h-screen flex flex-col items-center justify-center p-6",children:[e.jsxs(x.div,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},className:"mb-12 text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-gradient-to-br from-amber-400 to-amber-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-amber-500/20",children:e.jsx(X,{size:40,className:"text-white"})}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"فيلا حداد"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"بوابة اختيار الصور"})]}),e.jsxs(x.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"w-full max-w-md bg-[#1a1a1a] border border-white/5 rounded-3xl p-8 shadow-xl text-center",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"!اهلا بك"}),e.jsx("p",{className:"text-gray-400 mb-8 text-sm leading-relaxed",children:"أنت على وشك الدخول إلى معرض الصور الخاص بك. اضغط على الصور لاختيارها، ثم راجع اختيارك وأرسله. الصور المختارة سيتم تعديلها وتجهيزها لك."}),!n&&e.jsxs("div",{className:"flex items-center gap-2 text-red-400 text-sm mb-4 justify-center",children:[e.jsx(D,{size:16}),e.jsx("span",{children:"رابط غير صالح — يرجى التواصل مع الاستديو"})]}),e.jsxs("button",{disabled:!n,className:`w-full py-4 bg-amber-500 hover:bg-amber-600 disabled:bg-gray-700 disabled:text-gray-500
                  text-black font-bold rounded-xl transition-all hover:scale-105 active:scale-95
                  flex items-center justify-center gap-2`,onClick:G,children:[e.jsx("span",{children:"عرض الصور"}),e.jsx(F,{size:20})]}),e.jsxs("div",{className:"mt-6 flex items-center justify-center gap-2 text-xs text-gray-500",children:[e.jsx(J,{size:12}),e.jsx("span",{children:"رابط آمن وخاص بك"})]})]}),e.jsxs("footer",{className:"mt-12 text-center text-gray-600 text-xs",children:["© ",new Date().getFullYear()," Villa Hadad Studio"]})]},"welcome"),y==="gallery"&&e.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"min-h-screen flex flex-col",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-[#0f0f0f]/80 backdrop-blur-md border-b border-white/10 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-lg",children:(l==null?void 0:l.title)||"معرض الصور"}),e.jsx("p",{className:"text-xs text-gray-400",children:l!=null&&l.clientName?`مرحبا ${l.clientName} — اضغط على الصور لاختيارها`:"اضغط على الصور لاختيارها"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/20 px-3 py-1.5 rounded-lg flex items-center gap-2",children:[e.jsx(Z,{size:16,className:"text-amber-500 fill-amber-500"}),e.jsxs("span",{className:"text-amber-500 font-bold text-sm",children:[o,e.jsxs("span",{className:"text-amber-500/50 font-normal",children:[" / ",C]})]})]}),e.jsxs("button",{disabled:o===0,className:`bg-white text-black px-5 py-2.5 rounded-xl text-sm font-bold
                      hover:bg-gray-200 disabled:bg-gray-800 disabled:text-gray-600
                      transition-all flex items-center gap-2`,onClick:_,children:[e.jsx(H,{size:16}),e.jsx("span",{children:"مراجعة الاختيار"})]})]})]})}),e.jsxs("main",{className:"flex-1 p-6 max-w-7xl mx-auto w-full",children:[b==="loading"&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-32",children:[e.jsx(S,{size:48,className:"text-amber-500 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"جاري تحميل الصور..."})]}),b==="error"&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-32",children:[e.jsx(D,{size:48,className:"text-red-400 mb-4"}),e.jsx("p",{className:"text-red-400 text-sm mb-4",children:I}),e.jsx("button",{onClick:P,className:"px-4 py-2 bg-white/10 rounded-xl text-sm hover:bg-white/20 transition-colors",children:"إعادة المحاولة"})]}),b==="loaded"&&m.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-32",children:[e.jsx(ee,{size:48,className:"text-gray-600 mb-4"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"لا توجد صور بعد — يتم تجهيزها"})]}),b==="loaded"&&m.length>0&&e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3",children:m.map(t=>e.jsxs(x.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:`relative aspect-square rounded-2xl overflow-hidden cursor-pointer
                        transition-all duration-200 border-2
                        ${t.status==="selected"?"border-amber-500 ring-2 ring-amber-500/30 shadow-lg shadow-amber-500/10":"border-transparent hover:border-white/20"}`,onClick:()=>W(t.id),children:[e.jsx("img",{src:t.thumbnailUrl||t.cloudUrl||"",alt:t.fileName,className:"w-full h-full object-cover",loading:"lazy"}),e.jsx("div",{className:`absolute inset-0 transition-all duration-200 ${t.status==="selected"?"bg-amber-500/10":"bg-black/0 hover:bg-black/20"}`}),t.status==="selected"&&e.jsx(x.div,{initial:{scale:0},animate:{scale:1},className:"absolute top-3 right-3 bg-amber-500 rounded-full p-1.5 shadow-lg",children:e.jsx(z,{size:18,className:"text-white"})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 hover:opacity-100 transition-opacity",children:e.jsx("p",{className:"text-[10px] text-white/70 font-mono truncate",children:t.fileName})})]},t.id))})]}),b==="loaded"&&o>0&&e.jsx(x.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1},className:"sticky bottom-0 bg-[#0f0f0f]/90 backdrop-blur-md border-t border-white/10 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsxs("p",{className:"text-sm text-gray-400",children:["اخترت ",e.jsx("span",{className:"text-amber-500 font-bold",children:o})," صورة من أصل ",e.jsx("span",{className:"text-white font-bold",children:C})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>N(t=>t.map(s=>({...s,status:"pending"}))),className:"text-xs text-gray-500 hover:text-red-400 transition-colors",children:"إلغاء الكل"}),e.jsxs("button",{onClick:_,className:"bg-amber-500 text-black px-4 py-2 rounded-xl text-xs font-bold hover:bg-amber-600 transition-all",children:["مراجعة وإرسال (",o,")"]})]})]})})]},"gallery"),y==="review"&&e.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0},className:"min-h-screen flex flex-col",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-[#0f0f0f]/80 backdrop-blur-md border-b border-white/10 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>f("gallery"),className:"w-9 h-9 rounded-lg bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors",children:e.jsx(F,{size:18})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-lg",children:"مراجعة الاختيار"}),e.jsxs("p",{className:"text-xs text-gray-400",children:["تأكد من اختيارك قبل الإرسال — ",o," صورة مختارة"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{disabled:o===0||h==="downloading",className:`bg-white/10 text-white px-4 py-2.5 rounded-xl text-sm font-medium
                      hover:bg-white/20 disabled:bg-gray-800 disabled:text-gray-600
                      transition-all flex items-center gap-2 border border-white/10`,onClick:$,children:h==="downloading"?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:16,className:"animate-spin"}),e.jsxs("span",{children:[k.current,"/",k.total]})]}):h==="done"?e.jsxs(e.Fragment,{children:[e.jsx(z,{size:16,className:"text-green-400"}),e.jsx("span",{children:"تم التحميل"})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{size:16}),e.jsx("span",{children:"تحميل المختارة"})]})}),e.jsxs("button",{disabled:o===0||b==="submitting",className:`bg-amber-500 text-black px-5 py-2.5 rounded-xl text-sm font-bold
                      hover:bg-amber-600 disabled:bg-gray-800 disabled:text-gray-600
                      transition-all flex items-center gap-2`,onClick:B,children:[b==="submitting"?e.jsx(S,{size:16,className:"animate-spin"}):e.jsx(H,{size:16}),e.jsx("span",{children:"تأكيد وإرسال"})]}),e.jsxs("button",{disabled:o===0,className:`bg-green-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold
                      hover:bg-green-700 disabled:bg-gray-800 disabled:text-gray-600
                      transition-all flex items-center gap-2`,onClick:T,children:[e.jsx(O,{size:16}),e.jsx("span",{children:"إرسال واتساب للمصور"})]})]})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto w-full px-6 py-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-amber-500/5 border border-amber-500/15 rounded-2xl p-5 text-center",children:[e.jsx("p",{className:"text-3xl font-black text-amber-500",children:o}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"صورة مختارة"})]}),e.jsxs("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-5 text-center",children:[e.jsx("p",{className:"text-3xl font-black text-gray-400",children:C-o}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"لم تُختر"})]}),e.jsxs("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-5 text-center",children:[e.jsx("p",{className:"text-3xl font-black text-white",children:C}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"إجمالي الصور"})]})]}),e.jsx("h3",{className:"text-sm font-bold text-gray-300 mb-3",children:"الصور المختارة:"}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3",children:j.map((t,s)=>e.jsxs(x.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:s*.03},className:"relative aspect-square rounded-xl overflow-hidden border-2 border-amber-500/30 group",children:[e.jsx("img",{src:t.thumbnailUrl||t.cloudUrl||"",alt:t.fileName,className:"w-full h-full object-cover",loading:"lazy"}),e.jsx("button",{onClick:()=>E(t.id),className:"absolute top-2 left-2 w-6 h-6 bg-red-500/80 hover:bg-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all",children:e.jsx(te,{size:14,className:"text-white"})}),e.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] font-bold text-black",children:s+1})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2",children:e.jsx("p",{className:"text-[9px] text-white/70 font-mono truncate",children:t.fileName})})]},t.id))}),o===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(se,{size:40,className:"text-gray-600 mb-3"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"لم تختر أي صورة بعد"}),e.jsx("button",{onClick:()=>f("gallery"),className:"mt-4 px-4 py-2 bg-white/10 rounded-xl text-sm hover:bg-white/20 transition-colors",children:"العودة للمعرض"})]})]})]},"review"),y==="done"&&e.jsxs(x.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"min-h-screen flex flex-col items-center justify-center p-6 text-center",children:[e.jsx(x.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:20,delay:.2},className:"w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mb-8 shadow-2xl shadow-green-500/20",children:e.jsx(z,{size:48,className:"text-white"})}),e.jsx("h2",{className:"text-2xl font-bold mb-3",children:"تم إرسال اختيارك!"}),e.jsxs("p",{className:"text-gray-400 text-sm max-w-md leading-relaxed mb-2",children:["شكرا لك! تم اختيار"," ",e.jsx("span",{className:"text-amber-500 font-bold",children:o})," صورة بنجاح. سيتم تعديلها وتجهيزها لك في أقرب وقت."]}),e.jsx("p",{className:"text-gray-600 text-xs mb-8",children:"سيتم إعلامك عند الانتهاء من التعديل."}),e.jsx("button",{disabled:h==="downloading",className:`bg-white/10 text-white px-6 py-3 rounded-xl text-sm font-medium
                hover:bg-white/20 transition-all flex items-center gap-2 border border-white/10`,onClick:$,children:h==="downloading"?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:16,className:"animate-spin"}),e.jsxs("span",{children:[k.current,"/",k.total]})]}):h==="done"?e.jsxs(e.Fragment,{children:[e.jsx(z,{size:16,className:"text-green-400"}),e.jsx("span",{children:"تم التحميل"})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{size:16}),e.jsxs("span",{children:["تحميل الصور المختارة (",o,")"]})]})}),e.jsxs("button",{disabled:o===0,className:`mt-3 bg-green-600 text-white px-6 py-3 rounded-xl text-sm font-bold
                hover:bg-green-700 disabled:bg-gray-800 disabled:text-gray-600
                transition-all flex items-center gap-2`,onClick:T,children:[e.jsx(O,{size:16}),e.jsx("span",{children:"إرسال واتساب للمصور"})]}),e.jsxs("footer",{className:"mt-16 text-center text-gray-600 text-xs",children:["© ",new Date().getFullYear()," Villa Hadad Studio"]})]},"success")]})})};export{xe as default};
